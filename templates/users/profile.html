{% extends 'base.html' %}
{% load static %}

{% block title %}{{ profile_user.get_full_name|default:profile_user.username }} - –ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Left Sidebar -->
    <aside class="sidebar-left">
        <div class="categories-menu">
            <div class="categories-menu-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
            <ul class="categories-list">
                <li>
                    <a href="{% url 'articles:home' %}" class="category-item">
                        <span class="category-icon">üè†</span>
                        <span class="category-name">–ì–ª–∞–≤–Ω–∞—è</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="articles-feed">
        <!-- Profile Header -->
        <div class="article-detail">
            <div class="article-header">
                <div style="display: flex; align-items: center; gap: var(--space-6); margin-bottom: var(--space-4);">
                    <div class="blogger-avatar" style="width: 80px; height: 80px;">
                        {% if profile.avatar %}
                        <img src="{{ profile.avatar.url }}" alt="{{ profile_user.username }}">
                        {% else %}
                        <div class="avatar-placeholder" style="width: 100%; height: 100%; font-size: 2rem;">
                            {{ profile_user.username|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h1 style="font-size: 1.75rem; margin-bottom: var(--space-2);">
                            {{ profile_user.get_full_name|default:profile_user.username }}
                        </h1>
                        {% if profile.bio %}
                        <p style="color: var(--text-secondary); margin-bottom: var(--space-3);">
                            {{ profile.bio }}
                        </p>
                        {% endif %}
                        <div style="display: flex; gap: var(--space-6); font-size: 0.875rem;">
                            <span><strong>{{ stats.articles_count }}</strong> —Å—Ç–∞—Ç–µ–π</span>
                            <span><strong>{{ stats.followers_count }}</strong> –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span>
                            <span><strong>{{ stats.following_count }}</strong> –ø–æ–¥–ø–∏—Å–æ–∫</span>
                        </div>
                    </div>
                    {% if user.is_authenticated and user != profile_user %}
                    <div>
                        {% if is_following %}
                        <button class="btn btn-secondary">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
                        {% else %}
                        <button class="btn btn-primary">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if user == profile_user %}
                    <div>
                        <button class="btn btn-secondary" onclick="openEditProfile()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Articles Section -->
        <div style="margin-top: var(--space-6);">
            <h2 style="font-size: 1.25rem; margin-bottom: var(--space-4);">–°—Ç–∞—Ç—å–∏ –∞–≤—Ç–æ—Ä–∞</h2>

            {% if articles %}
                {% for article in articles %}
                <div class="article-card profile-article-card">
                    <a href="{{ article.get_absolute_url }}" class="article-link">
                        <div class="article-body">
                            <div class="article-author">
                                <span class="category-badge">{{ article.category.name }}</span>
                                <span style="color: var(--text-tertiary); font-size: 0.8125rem;">{{ article.published_at|date:"d M Y" }}</span>
                            </div>
                            <h3 class="article-title" style="font-size: 1.125rem; margin: 0.25rem 0 0.375rem 0;">{{ article.title }}</h3>
                            <p class="article-excerpt" style="font-size: 0.875rem; margin: 0;">{{ article.excerpt|default:article.content|truncatewords:15 }}</p>
                            <div class="article-meta-footer">
                                <div class="article-stats" style="font-size: 0.8125rem;">
                                    <span class="stat-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        {{ article.views_count }}
                                    </span>
                                    <span class="stat-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                        </svg>
                                        {{ article.likes_count }}
                                    </span>
                                </div>
                                <span class="article-time" style="font-size: 0.8125rem;">{{ article.reading_time }} –º–∏–Ω</span>
                            </div>
                        </div>
                        {% if article.cover_image %}
                        <div class="article-cover" style="width: 180px; height: 120px;">
                            <img src="{{ article.cover_image.url }}" alt="{{ article.title }}" loading="lazy">
                        </div>
                        {% endif %}
                    </a>
                    {% if user == profile_user %}
                    <div class="article-edit-btn">
                        <a href="{% url 'articles:edit' article.slug %}" class="edit-btn" onclick="event.stopPropagation();" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <p>–£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π</p>
                </div>
            {% endif %}
        </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
        <div class="sidebar-widget">
            <div class="widget-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div style="padding: var(--space-2) 0;">
                <p style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;">
                    {% if profile.bio %}
                        {{ profile.bio }}
                    {% else %}
                        –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–∏–ª –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ
                    {% endif %}
                </p>
            </div>
        </div>

        {% if profile.website or profile.twitter or profile.github %}
        <div class="sidebar-widget">
            <div class="widget-title">–°—Å—ã–ª–∫–∏</div>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                {% if profile.website %}
                <a href="{{ profile.website }}" target="_blank" style="font-size: 0.875rem; color: var(--color-primary);">
                    üåê –°–∞–π—Ç
                </a>
                {% endif %}
                {% if profile.twitter %}
                <a href="https://twitter.com/{{ profile.twitter }}" target="_blank" style="font-size: 0.875rem; color: var(--color-primary);">
                    üê¶ Twitter
                </a>
                {% endif %}
                {% if profile.github %}
                <a href="https://github.com/{{ profile.github }}" target="_blank" style="font-size: 0.875rem; color: var(--color-primary);">
                    üíª GitHub
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </aside>
</div>

{% if user == profile_user %}
<!-- Edit Profile Modal -->
<div class="modal-overlay" id="editProfileModal" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
        <button class="modal-close" onclick="closeEditProfile()">&times;</button>

        <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>

        <form method="post" enctype="multipart/form-data" id="editProfileForm" style="margin-top: 1.5rem;">
            {% csrf_token %}

            <!-- Avatar Section -->
            <div class="form-group">
                <label class="form-label">–ê–≤–∞—Ç–∞—Ä</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="blogger-avatar" style="width: 80px; height: 80px;" id="avatarPreview">
                        {% if profile.avatar %}
                        <img src="{{ profile.avatar.url }}" alt="{{ user.username }}" id="avatarImg">
                        {% else %}
                        <div class="avatar-placeholder" style="width: 100%; height: 100%; font-size: 2rem;" id="avatarPlaceholder">
                            {{ user.username|first|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div>
                        <input type="file" name="avatar" id="avatarInput" accept="image/*" style="display: none;" onchange="previewAvatar(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarInput').click()">
                            –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                        {% if profile.avatar %}
                        <button type="button" class="btn btn-text" onclick="removeAvatar()">–£–¥–∞–ª–∏—Ç—å</button>
                        {% endif %}
                    </div>
                </div>
                <small class="form-help-text">JPG, PNG. –ú–∞–∫—Å 5 –ú–ë</small>
            </div>

            <!-- Name Fields -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="first_name" class="form-label">–ò–º—è</label>
                    <input type="text" name="first_name" id="first_name" class="form-input" value="{{ user.first_name }}">
                </div>
                <div class="form-group">
                    <label for="last_name" class="form-label">–§–∞–º–∏–ª–∏—è</label>
                    <input type="text" name="last_name" id="last_name" class="form-input" value="{{ user.last_name }}">
                </div>
            </div>

            <!-- Email -->
            <div class="form-group">
                <label for="email" class="form-label">Email</label>
                <input type="email" name="email" id="email" class="form-input" value="{{ user.email }}" required>
            </div>

            <!-- Bio -->
            <div class="form-group">
                <label for="bio" class="form-label">–û —Å–µ–±–µ</label>
                <textarea name="bio" id="bio" class="form-input" rows="4" placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ...">{{ profile.bio }}</textarea>
            </div>

            <!-- Social Links -->
            <div class="form-group">
                <label class="form-label" style="margin-bottom: 0.75rem;">–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏</label>

                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üåê</span>
                        <input type="url" name="website" class="form-input" placeholder="–í–∞—à —Å–∞–π—Ç" value="{{ profile.website }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üê¶</span>
                        <input type="text" name="twitter" class="form-input" placeholder="Twitter" value="{{ profile.twitter }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üíª</span>
                        <input type="text" name="github" class="form-input" placeholder="GitHub" value="{{ profile.github }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üì±</span>
                        <input type="text" name="telegram" class="form-input" placeholder="Telegram" value="{{ profile.telegram }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üîó</span>
                        <input type="text" name="linkedin" class="form-input" placeholder="LinkedIn" value="{{ profile.linkedin }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üìπ</span>
                        <input type="text" name="youtube" class="form-input" placeholder="YouTube" value="{{ profile.youtube }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üíô</span>
                        <input type="text" name="vk" class="form-input" placeholder="VK" value="{{ profile.vk }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="width: 30px; text-align: center;">üì∑</span>
                        <input type="text" name="instagram" class="form-input" placeholder="Instagram" value="{{ profile.instagram }}">
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="modal-btn modal-btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                <button type="button" class="modal-btn" onclick="closeEditProfile()">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<style>
/* Compact article cards for profile page */
.profile-article-card {
    padding: 0.75rem 1rem !important;
    margin-bottom: 0.5rem !important;
    position: relative;
}

.profile-article-card .article-link {
    gap: 1rem !important;
}

.profile-article-card .article-body {
    padding: 0 !important;
}

.profile-article-card .article-author {
    margin-bottom: 0.25rem !important;
}

.profile-article-card .category-badge {
    padding: 0.2rem 0.5rem !important;
    font-size: 0.75rem !important;
}

.profile-article-card .article-cover {
    flex-shrink: 0;
    margin: 0 !important;
}

.profile-article-card .article-cover img {
    object-fit: cover;
    border-radius: 6px;
}

.profile-article-card .article-meta-footer {
    margin-top: 0.5rem !important;
}

/* Edit button styles */
.article-edit-btn {
    position: absolute;
    bottom: 0.75rem;
    right: 0.75rem;
    z-index: 10;
}

.edit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--background-primary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-secondary);
    transition: all 0.2s ease;
    cursor: pointer;
}

.edit-btn:hover {
    background: var(--color-primary);
    color: white;
    border-color: var(--color-primary);
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.edit-btn svg {
    width: 16px;
    height: 16px;
}

/* Form styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.9375rem;
    background: var(--background-primary);
    color: var(--text-primary);
    transition: border-color 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--color-primary);
}

.form-help-text {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.8125rem;
    color: var(--text-tertiary);
}

.btn-text {
    background: none;
    border: none;
    color: var(--color-danger);
    padding: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
}

.btn-text:hover {
    text-decoration: underline;
}
</style>

<script>
function openEditProfile() {
    document.getElementById('editProfileModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeEditProfile() {
    document.getElementById('editProfileModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function previewAvatar(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${e.target.result}" alt="Avatar preview" id="avatarImg">`;
        };
        reader.readAsDataURL(file);
    }
}

function removeAvatar() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–≤–∞—Ç–∞—Ä?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.innerHTML = `
            {% csrf_token %}
            <input type="hidden" name="remove_avatar" value="1">
        `;
        document.body.appendChild(form);
        form.submit();
    }
}

// Close modal on outside click
document.getElementById('editProfileModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditProfile();
    }
});
</script>
{% endif %}

{% endblock %}
