{% extends 'base.html' %}
{% load static humanize markdown_extras %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Left Sidebar - Categories & Popular Posts -->
    <aside class="sidebar-left">
        <!-- Categories Menu -->
        <div class="categories-menu">
            <div class="categories-menu-title">–¢–µ–º—ã</div>
            <ul class="categories-list" id="categoriesList">
                {% for category in categories %}
                <li class="category-list-item {% if forloop.counter > 10 %}category-hidden{% endif %}">
                    <a href="{% url 'articles:category' category.slug %}" class="category-item {% if current_category.id == category.id %}active{% endif %}">
                        {% if category.icon_image %}
                            <img src="{{ category.icon_image.url }}" alt="{{ category.name }}" class="category-icon-img" loading="lazy">
                        {% else %}
                            <span class="category-icon">{{ category.icon }}</span>
                        {% endif %}
                        <span class="category-name">{{ category.name }}</span>
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% if categories|length > 10 %}
            <button class="show-all-categories-btn" id="showAllCategoriesBtn" onclick="toggleAllCategories()">
                <span class="show-all-icon">‚ñº</span>
                <span class="show-all-text">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</span>
            </button>
            {% endif %}
        </div>

        <!-- Popular Posts Widget -->
        <div class="popular-posts-widget">
            <div class="widget-title">–ü–æ–ø—É–ª—è—Ä–Ω–æ–µ</div>
            {% for article in popular_articles|slice:":5" %}
            <a href="{{ article.get_absolute_url }}" class="popular-post-item">
                <div class="popular-post-title">{{ article.title|truncatewords:8 }}</div>
                <div class="popular-post-stats">
                    <span>üëÅ {{ article.views_count }}</span>
                    <span>‚ù§Ô∏è {{ article.likes_count }}</span>
                </div>
            </a>
            {% endfor %}
        </div>
    </aside>

    <!-- Center Content - Articles Feed -->
    <main class="articles-feed">
        {% if search_query %}
        <div class="feed-header">
            <h1 class="feed-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "{{ search_query }}"</h1>
            <p class="feed-subtitle">–ù–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ç–µ–π: {{ articles.paginator.count }}</p>
        </div>
        {% elif current_category %}
        <div class="feed-header">
            <h1 class="feed-title">{{ current_category.icon }} {{ current_category.name }}</h1>
            <p class="feed-subtitle">{{ current_category.description }}</p>
        </div>
        {% endif %}

        <!-- Articles List -->
        {% for article in articles %}
        <article class="article-card">
            <!-- Author Info First -->
            <div class="article-author">
                <div class="author-avatar">
                    {% if article.author.profile.avatar %}
                    <img src="{{ article.author.profile.avatar.url }}" alt="{{ article.author.username }}" loading="lazy">
                    {% else %}
                    <div class="avatar-placeholder">{{ article.author.username|first|upper }}</div>
                    {% endif %}
                </div>
                <div class="author-details">
                    <span class="author-name">{{ article.author.get_full_name|default:article.author.username }}</span>
                    <span class="article-time">{{ article.published_at|naturaltime }}</span>
                </div>
                {% if article.category %}
                <span class="category-badge">{{ article.category.name }}</span>
                {% endif %}
            </div>

            <!-- Title - full width -->
            <a href="{{ article.get_absolute_url }}" class="article-title-link">
                <h2 class="article-title-vk">
                    {% if article.is_pinned and article.pin_order > 0 %}
                    <span class="pin-badge" title="–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ ({{ article.pin_order }})">üìå</span>
                    {% endif %}
                    {{ article.title|striptags }}
                </h2>
            </a>

            <!-- Cover Image/Video - full width -->
            {% if article.cover_video %}
            <a href="{{ article.get_absolute_url }}" class="article-cover-link">
                <div class="article-cover-vk article-cover-has-video">
                    <video class="article-cover-video-preview" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause()">
                        <source src="{{ article.cover_video.url }}" type="video/mp4">
                    </video>
                    <div class="video-play-icon">‚ñ∂</div>
                </div>
            </a>
            {% elif article.cover_video_url %}
                {% if 'youtube:' in article.cover_video_url or 'youtube.com' in article.cover_video_url or 'youtu.be' in article.cover_video_url %}
                    {# YouTube –≤–∏–¥–µ–æ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é #}
                    <a href="{{ article.get_absolute_url }}" class="article-cover-link">
                        <div class="article-cover-vk article-cover-has-video">
                            {% if 'youtube:' in article.cover_video_url %}
                                <img src="https://img.youtube.com/vi/{{ article.cover_video_url|slice:'8:' }}/maxresdefault.jpg" alt="{{ article.cover_alt|default:article.title }}" loading="lazy">
                            {% else %}
                                {# –ò–∑–≤–ª–µ—á—å ID –∏–∑ URL - —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç #}
                                <img src="https://img.youtube.com/vi/{{ article.cover_video_url|slice:'-11:' }}/maxresdefault.jpg" alt="{{ article.cover_alt|default:article.title }}" loading="lazy">
                            {% endif %}
                            <div class="video-play-icon">‚ñ∂</div>
                        </div>
                    </a>
                {% else %}
                    {# –û–±—ã—á–Ω–æ–µ –≤–∏–¥–µ–æ –ø–æ URL #}
                    <a href="{{ article.get_absolute_url }}" class="article-cover-link">
                        <div class="article-cover-vk article-cover-has-video">
                            <video class="article-cover-video-preview" muted loop playsinline onmouseenter="this.play()" onmouseleave="this.pause()">
                                <source src="{{ article.cover_video_url }}" type="video/mp4">
                            </video>
                            <div class="video-play-icon">‚ñ∂</div>
                        </div>
                    </a>
                {% endif %}
            {% elif article.cover_image %}
            <a href="{{ article.get_absolute_url }}" class="article-cover-link">
                <div class="article-cover-vk">
                    <img src="{{ article.cover_image.url }}" alt="{{ article.cover_alt|default:article.title }}" loading="lazy">
                </div>
            </a>
            {% endif %}

            <!-- Excerpt Text - full width -->
            <div class="article-excerpt-vk">
                <p>{{ article.excerpt|markdown|striptags|truncatewords:50 }}</p>
            </div>

            <!-- Show More Button & Stats -->
            <div class="article-footer-vk">
                <a href="{{ article.get_absolute_url }}" class="show-more-btn">–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é...</a>

                <div class="article-stats-vk">
                    <span class="stat-item">
                        üí¨ {{ article.comments_count }}
                    </span>
                    <span class="stat-item">
                        üëÅ {{ article.views_count }}
                    </span>
                    <span class="stat-item">
                        ‚ù§Ô∏è {{ article.likes_count }}
                    </span>
                </div>
            </div>
        </article>
        {% empty %}
        <div class="empty-state">
            <p>–°—Ç–∞—Ç—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            {% if search_query %}
                <a href="{% url 'articles:home' %}" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Å—Ç–∞—Ç—å–∏</a>
            {% endif %}
        </div>
        {% endfor %}
    </main>

    <!-- Right Sidebar - Top Bloggers & Comments -->
    <aside class="sidebar-right">
        <!-- Top Bloggers -->
        <div class="sidebar-widget">
            <div class="widget-title">–¢–æ–ø –±–ª–æ–≥–µ—Ä—ã</div>
            {% for blogger in top_bloggers|slice:":3" %}
            <div class="blogger-item">
                <span class="blogger-rank">{{ forloop.counter }}</span>
                <a href="{% url 'users:profile' blogger.username %}" class="blogger-avatar">
                    {% if blogger.profile.avatar %}
                        <img src="{{ blogger.profile.avatar.url }}" alt="{{ blogger.username }}">
                    {% else %}
                        <div class="avatar-placeholder">{{ blogger.username|first|upper }}</div>
                    {% endif %}
                </a>
                <div class="blogger-info">
                    <a href="{% url 'users:profile' blogger.username %}" class="blogger-name">
                        {{ blogger.get_full_name|default:blogger.username }}
                    </a>
                    <div class="blogger-stats">{{ blogger.article_count }} —Å—Ç–∞—Ç–µ–π</div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Popular Comments -->
        <div class="sidebar-widget">
            <div class="widget-title">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
            {% for comment in popular_comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <div class="comment-author-avatar">
                        {% if comment.user.profile.avatar %}
                            <img src="{{ comment.user.profile.avatar.url }}" alt="{{ comment.user.username }}">
                        {% else %}
                            <div class="avatar-placeholder">{{ comment.user.username|first|upper }}</div>
                        {% endif %}
                    </div>
                    <span class="comment-author-name">{{ comment.user.get_full_name|default:comment.user.username }}</span>
                </div>
                <p class="comment-text">{{ comment.content|truncatewords:15 }}</p>
                <a href="{{ comment.article.get_absolute_url }}#comment-{{ comment.id }}" class="comment-link">
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å—Ç–∞—Ç—å–µ ‚Üí
                </a>
            </div>
            {% endfor %}
        </div>
    </aside>
</div>
{% endblock %}
